# Лабораторная работа № 1.2
## Использование динамических библиотек

Разработать на языке C для ОС Linux:

- программу, позволяющую выполнять рекурсивный поиск файлов, начиная с
указанного каталога, с помощью динамических (разделяемых) библиотек-плагинов
(использовать в качестве основы программу, разработанную в лабораторной работе
1.1);
- динамическую библиотеку, реализующую заданный вариантом лабораторной работы
из Табл. 4 критерий поиска файлов.
Программа должна представлять собой консольную утилиту, настройка работы
которой осуществляется путем передачи аргументов в строке запуска и/или с помощью
переменных окружения:

```
lab12abcNXXXXX [опции] [каталог]
```

Программа должна выполнять рекурсивный поиск файлов, отвечающих критериям,
которые задаются опциями в командной строке. Доступные критерии поиска (и,
соответственно, доступные опции) определяются наличием в заданном каталоге
динамических библиотек, расширяющих функциональность программы (далее — плагинов).

При запуске без имени каталога для поиска программа выводит справочную
информацию по опциям и доступным в момент запуска плагинам. Поддерживаемые
программой опции перечислены в Табл. 2. Выводятся все опции, поддерживаемые
плагинами, и их описание. По умолчанию плагины ищутся в том же каталоге, где
расположен исполняемый файл программы, а если задана опция `-P`, то в каталоге, указанном
в этой опции. В случае запуска программы с несколькими опциями, задающими критерии
поиска, эти критерии объединяются логической операцией «И» (то же самое, если задана
опция `-A`) или логической операцией «ИЛИ» (если задана опция `-O`). Если задана опция `-N`,
то после объединения всех условий поиска по «И» или «ИЛИ», оно меняется на
противоположное.

Плагины представляют собой динамические библиотеки в формате ELF с
произвольным именем и расширением .so и интерфейсными функциями, перечисленными в
Табл. 1. Подробное описание API плагинов содержится в файле `plugin_api.h`.

При обнаружении файла, отвечающего заданным критериям поиска, в стандартный
поток вывода выводится полный путь к этому файлу. При определении переменной
окружения `LAB1DEBUG` в стандартный поток ошибок должна выводиться информация о том,
что и в каком месте файла нашлось (чтобы было легче понять, почему файл отвечает
критериям поиска), а также может выводиться любая дополнительная отладочная
информация. Переменные окружения, которые должны поддерживаться программой и
библиотекой, приведены в Табл. 3.



___
**Замечание 1.** При выполнении лабораторной работы следует использовать функции
стандартной библиотеки С и системные вызовы операционной системы. Использовать ввод-
вывод в стиле С++ (классы `ifstream`/`ofstream`/...) запрещено. Использовать контейнеры и
алгоритмы STL (`<string>`, `<vector>`, `<map>`, ...) запрещено.

**Замечание 2.** В программах должна присутствовать обработка ошибок: в случаях, если
пользователь задал неверную комбинацию опций, указал файлы, которые невозможнооткрыть,
и т.д. программа должна выдавать диагностическое сообщение на консоль (в
стандартный поток ошибок и/или лог-файл), прежде чем завершиться.

**Замечание 3.** При обходе дерева каталогов нужно учитывать, что доступ к некоторым
файлам и каталогам может завершиться с ошибкой (например, по причине отсутствия прав
доступа и т.д.). В таком случае следует вывести сообщение об ошибке в стандартный поток
ошибок и продолжить обход. Для упрощения реализации обхода символические ссылки (и
аналогичные средства — жесткие ссылки, bind mount'ы и т.д.) можно игнорировать.

**Замечание 4.** Категорически запрещается использовать статические массивы (с размерами,
заданными на этапе компиляции) для любых данных, размер которых зависит от входных
данных или условий запуска. Для хранения таких данных необходимо использовать
динамическую память и определять объем необходимой памяти в зависимости от ситуации.
Статические массивы можно использовать в тех ситуациях, когда известен максимальный
размер обрабатываемых данных (и он не превышает размеров стека или максимального
размера статических массивов, допускаемого компилятором).

**Замечание 5.** Плагинами поддерживаются только длинные опции. Плагин может
поддерживать несколько опций (например, в целях отладки). Совпадение имен опций в
разных плагинах считается ошибкой.

**Замечание 6.** Информационные сообщения выводятся программой в стандартный поток
вывода, сообщения об ошибках — в стандартный поток ошибок. С помощью определения
переменной окружения `LAB1DEBUG` можно включить вывод отладочных сообщений
программой и плагинами в стандартный поток ошибок. Рекомендуется предварять все
сообщения плагина его названием (чтобы было легче разбираться, каким плагином были
выведены сообщения).

**Замечание 7.** Плагины (в качестве потенциальных плагинов можно рассматривать любые
файлы с расширением .so) по умолчанию ищутся в том же каталоге, где расположен
исполняемый файл. Обратите внимание, что этот каталог может не совпадать с текущим
рабочим каталогом. Опция `-P` позволяет задать каталог с плагинами явно.

**Замечание 8.** Несмотря на то, что для компиляции программ необходимо использовать
компилятор gcc, использования расширений GNU C желательно по возможности избегать и
ориентироваться на использование стандарта C11 или более позднего.

**Замечание 9.** В вариантах, предусматривающих поиск многобайтовых значений (бинарных,
«упакованных» данных) нужно предусмотреть поиск вариантов хранения данных и в little-
endian, и в big-endian порядке.

**Замечание 10.** В вариантах, где необходимо сравнивать некоторые величины с заданными
значениями, операторы сравнения задаются следующим образом: `eq` означает «равно»
(equal), `ne` означает «не равно» (not equal), `gt` означает «строго больше» (greater than),
`lt` означает «строго меньше» (less than), `ge` означает «больше или равно» (greater or equal),
`le` означает «меньше или равно» (less or equal).

**Замечание 11.** Опции `-A`, `-O` и `-N` должны работать следующим образом. Предположим,
программе доступно два плагина. Первый поддерживает опцию `--exe`, позволяющую найти
любые исполняемые файлы, второй — опцию `--file-len`, позволяющую найти файлы
заданной длины.

При запуске `./lab1abcNXXXXX --exe --file-len 1000 /tmp`
программа должна искать в каталоге `/tmp` и вложенных в него исполняемые файлы длиной
1000 байтов.

При запуске `./lab1abcNXXXXX -O --exe --file-len 1000 /tmp`
программа должна искать в каталоге `/tmp` и вложенных в него или исполняемые файлы, или
файлы длиной 1000 (то есть совпадение должно быть хотя бы по одному из критериев).

В случае запуска `./lab1abcNXXXXX -O -N --exe --file-len 1000 /tmp`
программа должна искать файлы, которые не являются исполняемыми и не имеют длину
1000 байтов.



---
**Таблица 1.** Интерфейсные функции библиотеки-плагина

Функция | Назначение
--- | ---
plugin_get_info | Получение информации о поддерживаемых плагином опциях.
plugin_process_file | Проверка соответствия файла заданным критериям.


**Таблица 2.** Опции командной строки, поддерживаемые программой

Опция | Назначение
--- | ---
-P dir | Каталог с плагинами.
-A | Объединение опций плагинов с помощью операции «И» (действует по умолчанию).
-O | Объединение опций плагинов с помощью операции «ИЛИ».
-N | Инвертирование условия поиска (после объединения опций плагинов с помощью -A или -O).
-v | Вывод версии программы и информации о программе.
-h | Вывод справки по опциям.


**Таблица 3.** Переменные окружения, поддерживаемые программой и динамической библиотекой

Переменная | Назначение
--- | ---
LAB1DEBUG | Включение вывода отладочной информации.


**Таблица 4.** Опции, поддерживаемые библиотекой-плагином

1. Опция: `--crc16 <значение>`  
Назначение: поиск файлов, контрольная сумма которых, рассчитанная с помощью
алгоритма CRC-16-CCITT, равна заданному значению. Значение суммы задается
строкой, содержащей запись числа либо в двоичной (0b…), либо в десятичной,
либо шестнадцатеричной (0x…) системах.  
Пример: `--crc16 0xbabe`

1. Опция: `--mac-addr <значение>`  
Назначение: поиск файлов, содержащих заданное значение MAC-адреса в
текстовой форме (в форматах `aa-bb-cc-dd-ee-ff`, `aa:bb:cc:dd:ee:ff`, `aabbccddeeff`, или
`aa bb cc dd ee ff`).  
Пример: `--mac-addr b9:c0:ae:12:8d:b3`

1. Опция: `--ipv4-addr <значение>`  
Назначение: поиск файлов, содержащих заданное значение IPv4-адреса либо в
текстовой форме (`x.x.x.x`), либо в бинарной (little-endian или big-endian).  
Пример: `--ipv4-addr 192.168.8.1`

1. Опция: `--freq-byte <значение>`  
Назначение: поиск файлов, в которых заданный байт - самый частый. Значение
может задаваться в двоичной (0b...), десятичной или шестнадцатеричной системах
(0x...).  
Пример: `--freq-byte 0xfe`

1. Опция: `--bit-seq <значение>`  
Назначение: поиск файлов, содержащих заданную последовательность битов.  
Значение последовательности задается строкой, содержащей запись числа либо в
двоичной (0b…), либо в десятичной, либо шестнадцатеричной (0x…) системах.  
Длина битовой последовательности может быть произвольной.  
Пример: `--bit-seq 0b1101101000016`

1. Опция: `--parity <значение>`  
Назначение: поиск файлов, содержащих четных и нечетных байтов в отношении,
заданном значением опции (`odds` - нечетных байтов больше, `evens` - четных
байтов больше, `eq` - четных и нечетных поровну).
Пример: `--parity odds`

1. Опция: `--float <значение>`  
Назначение: поиск файлов, содержащих текстовую запись вещественного числа в
указанном диапазоне значений. Параметр опции имеет формат `b@r`, что означает
поиск чисел b±r. Вещественное число может быть записано в обычном или
научном форматах.  
Пример: `--float 3.14@0.5e1`

1. Опция: `--float-bin <значение>`  
Назначение: поиск файлов, содержащих заданное вещественное число одинарной
точности в бинарной (little-endian или big-endian) форме, т. е. в виде четырех
последовательных октетов с соответствующими значениями. Вещественное число
может быть записано в обычном или научном форматах.  
Пример: `--float-bin 2.71`

1. Опция: `--ipv6-addr <значение>`  
Назначение: поиск файлов, содержащих заданное значение Ipv6-адреса в текстовой
форме.  
Допустимы сокращенные формы записи (например,
`2001:0db8:0000:0000:0000:0000:0000:7334` - то же самое, что `2001:0db8::7334`).  
Пример: `--ipv6-addr 2001:db8::1`
Опции: `--lines-count <значение>`, `--lines-count-comp <значение>`  
Назначение: поиск файлов, содержащих заданное количество строк. Значение
опции `--lines-count` задает количество строк, значение опции `--lines-count-comp` -
оператор сравнения (`eq`, `ne`, `gt`, `lt`, `ge`, `le`).  
Пример: `--lines-count 100` `--lines-count-comp ge`

1. Опция: `--anagram <значение>`  
Назначение: поиск файлов, содержащих строку или её анаграмму. Например,
строка «New York Times» является анаграммой строки «monkeys write».  
Пробельные символы и регистр букв не учитываются.  
Пример: `--anagram "new york times"`

1. Опция: `--crc32 <значение>`  
Назначение: поиск файлов, контрольная сумма которых, рассчитанная с помощью
алгоритма CRC-32, равна заданному значению. Значение суммы задается строкой,
содержащей запись числа либо в двоичной (0b…), либо в десятичной, либо
шестнадцатеричной (0x…) системах.  
Пример: `--crc32 0xcafebabe`

1. Опция: `--pic <значение>`  
Назначение: поиск файлов, содержащих изображения в форматах JPEG, PNG, GIF
и BMP. Признаком формата считать соответствующее магическое число в
заголовке файла. Значением опции является строка, в которой перечисляются через
запятую без пробелов форматы, которые требуется найти.  
Пример: `--pic png,gif`

1. Опция: `--exe <значение>`  
Назначение: поиск исполняемых файлов в форматах ELF, PE32, a.out и COFF.  
Признаком формата считать соответствующее магическое число в заголовке
файла. Значением опции является строка, в которой перечисляются через запятую
без пробелов форматы, которые требуется найти.  
Пример: `--exe pe32,elf,a.out`

1. Опция: `--double-bin`  
Назначение: поиск файлов, содержащих заданное вещественное число двойной
точности в бинарной (little-endian или big-endian) форме, т. е. в виде восьми
последовательных октетов с соответствующими значениями. Вещественное число
может быть записано в обычном или научном форматах.  
Пример: `--double-bin 2.71`

1. Опция: `--bytes <значение>`  
Назначение: поиск файлов, содержащих все указанные байты (не обязательно17
последовательно). Значения байтов задаются разделенными запятыми строками,
содержащими запись числа либо в двоичной (0b…), либо в десятичной, либо
шестнадцатеричной (0x…) системах.  
Пример: `--bytes 10,20,0x18`  

1. Опции: `--same-bytes <значение>`, `--same-bytes-comp <значение>`  
Назначение: поиск файлов, содержащих хотя бы один участок из заданного
количества повторяющихся байтов. Значение опции `--same-bytes` задает длину
участка, а значение опции `--same-bytes-comp` - оператор сравнения (`eq`, `ne`,
`gt`, `lt`, `ge`, `le`).  
Пример: `--same-bytes 10` `--same-bytes-comp eq`

1. Опция: `--mac-addr-bin <значение>`  
Назначение: поиск файлов, содержащих заданное значение MAC-адреса в
бинарной (little-endian или big-endian) форме.  
Пример: `--mac-addr-bin a0:12:ce:78:9f:b4`

1. Опция: `--ipv4-addr-bin <значение>`  
Назначение: поиск файлов, содержащих заданное значение IPv4-адреса в бинарной
(little-endian или big-endian) форме, т. е. в виде четырех последовательных октетов
с заданными значениями.  
Пример: `--ipv4-addr-bin 192.168.8.1`

1. Опция: `--uuids`  
Назначение: поиск файлов, содержащих хотя бы один универсальный уникальный
идентификатор (UUID) в наиболее употребимом текстовом формате (32
шестнадцатеричных цифры группами 8-4-4-4-12, например,
`123e4567-e89b-12d3-a456-426655440000`).  
Пример: `--uuids`

1. Опция: `--ccards`  
Назначение: поиск файлов, содержащих корректные номера кредитных карт в
текстовой форме (либо 16 цифр подряд, либо с разделителями между группами по
4 цифры). Корректность номера проверяется алгоритмом Луна.  
Пример: `--ccards`

1. Опция: `--dl-syms <список символов через запятую>`  
Назначение: поиск динамических библиотек, содержащих все заданные символы.  
Значением опции является список символов, разделитель - запятая.  
Пример: `--dl-syms plugin_get_info,plugin_process_file`

1. Опции: `--seq-num <значение>`, `--seq-num-comp <значение>`  
Назначение: поиск файлов, содержащих заданное количество последовательностей
одинаковых байтов (например, подряд три нулевых байта, затем в другом месте
десять подряд байтов со значением 100 и т.д.). Значение опции `--seq-num` задает
количество последовательностей, а значение опции `--seq-num-comp` - оператор
сравнения (`eq`, `ne`, `gt`, `lt`, `ge`, `le`).  
Пример: `--seq-num 10` `--seq-num-comp ge`

1. Опция: `--ccards-bin`  
Назначение: поиск файлов, содержащих корректные номера кредитных карт в
бинарной (little-endian или big-endian) форме (8 байтов, по 4 бита на цифру).  
Корректность номера проверяется алгоритмом Луна.  
Пример: `--ccards-bin`
